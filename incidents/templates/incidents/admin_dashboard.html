{% extends "incidents/base.html" %}
{% block content %}

<style>
    /* Layout Wrappers */
    .section {
        margin-bottom: 26px;
    }

    /* Metric Cards */
    .metrics {
        display: flex;
        gap: 18px;
        margin-bottom: 24px;
    }
    .metric-card {
        flex: 1;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        padding: 18px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        text-align: center;
    }
    .metric-label {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 4px;
    }
    .metric-value {
        font-size: 24px;
        font-weight: 600;
        color: #111827;
    }

    /* Filter Row */
    .filter-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .filter-select {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: #ffffff;
    }

    /* Table */
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 6px;
        font-size: 14px;
    }

    th {
        text-align: left;
        padding: 8px 10px;
        color: #374151;
        font-weight: 600;
        letter-spacing: .3px;
    }

    tr {
        background: #ffffff;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }

    td {
        padding: 12px 14px;
        vertical-align: middle;
    }

    /* Buttons */
    .btn-sm {
        padding: 6px 10px;
        font-size: 13px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }
    .btn-blue {
        background: #2563eb;
        color: white;
    }
    .btn-grey {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        color: #111827;
    }

    /* Badges */
    .badge {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 500;
    }
    .badge-open { background: #dbeafe; color: #1e40af; }
    .badge-progress { background: #fef3c7; color: #92400e; }
    .badge-resolved { background: #dcfce7; color: #166534; }

    .sev-critical { background: #fee2e2; color: #b91c1c; border: 1px solid #ef4444; }
    .sev-high { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
    .sev-medium { background: #e0f2fe; color: #0369a1; border: 1px solid #0284c7; }
    .sev-low { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }

    /* Title Section */
    .section-title {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 600;
        color: #111827;
    }
</style>


<!-- ===== HEADER ===== -->
<h2 style="margin-bottom: 20px;">Admin Dashboard</h2>


<!-- ===== METRICS ===== -->
<div class="metrics">
    <div class="metric-card">
        <div class="metric-label">Total Incidents</div>
        <div class="metric-value">{{ total_incidents }}</div>
    </div>

    <div class="metric-card">
        <div class="metric-label">Critical</div>
        <div class="metric-value">{{ critical_count }}</div>
    </div>

    <div class="metric-card">
        <div class="metric-label">Open</div>
        <div class="metric-value">{{ open_count }}</div>
    </div>

    <div class="metric-card">
        <div class="metric-label">Resolved</div>
        <div class="metric-value">{{ resolved_count }}</div>
    </div>
</div>


<!-- ===== FILTERS + CREATE BTN ===== -->
<div class="filter-row">
    <a href="{% url 'create_incident' %}" class="btn btn-blue">+ New Incident</a>

    <form method="get" style="display:flex; gap:10px;">
        <select name="status" class="filter-select">
            <option value="">All Status</option>
            <option value="OPEN" {% if status_filter == "OPEN" %}selected{% endif %}>Open</option>
            <option value="IN_PROGRESS" {% if status_filter == "IN_PROGRESS" %}selected{% endif %}>In Progress</option>
            <option value="RESOLVED" {% if status_filter == "RESOLVED" %}selected{% endif %}>Resolved</option>
        </select>

        <select name="severity" class="filter-select">
            <option value="">All Severity</option>
            <option value="CRITICAL" {% if severity_filter == "CRITICAL" %}selected{% endif %}>Critical</option>
            <option value="HIGH" {% if severity_filter == "HIGH" %}selected{% endif %}>High</option>
            <option value="MEDIUM" {% if severity_filter == "MEDIUM" %}selected{% endif %}>Medium</option>
            <option value="LOW" {% if severity_filter == "LOW" %}selected{% endif %}>Low</option>
        </select>

        <button type="submit" class="btn-sm btn-grey">Apply</button>
    </form>
</div>


<!-- ===== INCIDENT LIST ===== -->
<div class="section-title">All Incidents</div>

{% if incidents %}
<table>
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Severity</th>
        <th>Status</th>
        <th>Assign / Update</th>
        <th>Close</th>
    </tr>

    {% for inc in incidents %}
    <tr>
        <td>{{ inc.id }}</td>

        <td>
            <strong>{{ inc.title }}</strong><br>
            <small>{{ inc.created_by }} â€¢ {{ inc.created_at|date:"Y-m-d H:i" }}</small>
        </td>

        <td>
            {% if inc.severity == "CRITICAL" %}
                <span class="badge sev-critical">Critical</span>
            {% elif inc.severity == "HIGH" %}
                <span class="badge sev-high">High</span>
            {% elif inc.severity == "MEDIUM" %}
                <span class="badge sev-medium">Medium</span>
            {% else %}
                <span class="badge sev-low">Low</span>
            {% endif %}
        </td>

        <td>
            {% if inc.status == "OPEN" %}
                <span class="badge badge-open">Open</span>
            {% elif inc.status == "IN_PROGRESS" %}
                <span class="badge badge-progress">In Progress</span>
            {% else %}
                <span class="badge badge-resolved">Resolved</span>
            {% endif %}
        </td>

        <td>
            <form method="post" style="margin:0;">
                {% csrf_token %}
                <input type="hidden" name="incident_id" value="{{ inc.id }}">
                <input type="hidden" name="action" value="update">

                {% if inc.assigned_to %}
                    <strong>{{ inc.assigned_to.username }}</strong>
                    <input type="hidden" name="assigned_to" value="{{ inc.assigned_to.id }}">
                {% else %}
                    <select name="assigned_to" class="filter-select">
                        <option value="">Unassigned</option>
                        {% for u in support_users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endfor %}
                    </select>
                {% endif %}

                <br>

                <select name="status" class="filter-select" style="margin-top:6px;">
                    <option value="OPEN" {% if inc.status == "OPEN" %}selected{% endif %}>Open</option>
                    <option value="IN_PROGRESS" {% if inc.status == "IN_PROGRESS" %}selected{% endif %}>In Progress</option>
                    <option value="RESOLVED" {% if inc.status == "RESOLVED" %}selected{% endif %}>Resolved</option>
                </select>

                <button class="btn-sm btn-blue" style="margin-top:8px;">Save</button>
            </form>
        </td>

        <td>
            {% if inc.status != "RESOLVED" %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="incident_id" value="{{ inc.id }}">
                <input type="hidden" name="action" value="close">
                <button class="btn-sm btn-grey">Close</button>
            </form>
            {% else %}
                <em>Closed</em>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

{% else %}
<p>No incidents found.</p>
{% endif %}

{% endblock %}
